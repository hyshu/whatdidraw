# Design Document - What Did I Draw

## Overview

What Did I Draw is a drawing quiz game for Reddit's Devvit platform. Users create drawings with answers, and others guess by watching the drawing replay. The system provides scoring and per-drawing rankings.

**Core Modes:**
1. **Create Mode**: Draw with basic tools, set answer/hint, and optionally share to subreddit
2. **Quiz Mode**: Watch replay and submit guesses for points
3. **Leaderboard Mode**: View global player rankings (total scores), per-drawing top 5 scores, and subreddit-specific rankings
4. **My History Mode**: View personal quiz history and navigate to per-drawing leaderboards
5. **Subreddit Browse Mode**: Browse and play quizzes shared to specific subreddits

## Architecture

### System Structure

```
┌─────────────────┐         ┌─────────────────┐         ┌─────────────┐
│   Client        │  HTTP   │   Server        │  Redis  │   Storage   │
│  (Phaser.js)    │ ◄─────► │  (Handlers)     │ ◄─────► │   (Redis)   │
└─────────────────┘         └─────────────────┘         └─────────────┘
```

### Component Architecture

Three core modules handle all functionality:

1. **Drawing Module**: Canvas interface with tool management
2. **Quiz Module**: Playback engine and guess handling
3. **Data Module**: Redis operations and scoring logic

## Component Integration

### Drawing Creation
```
User draws → Validate (min 1 stroke) → Sanitize text → Store to Redis → Return unique ID → Optional: Share to Subreddit
```

### Quiz Gameplay
```
Load drawing → Initialize playback → User watches/guesses → Calculate score → Update rankings atomically
```

### Score Processing
```
Submit guess → Validate answer → Calculate points → Store score (atomic) → Update leaderboard → Return results
```

### Integration Points (Requirement 8)

**Drawing Creation to Storage:**
- Drawing_System sends: stroke data, answer, hint, metadata
- Storage_System generates unique ID using Redis INCR
- Storage_System returns: drawing ID
- Drawing_System displays confirmation with ID

**Storage to Playback:**
- Quiz_Interface requests drawing by ID or random
- Storage_System retrieves and decompresses data
- Playback_System receives complete drawing data
- Playback_System notifies Quiz_Interface when ready

**Playback to Scoring:**
- During playback: Playback_System tracks stroke progress
- On guess: Quiz_Interface sends guess text
- Quiz_Interface sends elapsed time
- Playback_System sends viewed stroke count
- Scoring_System receives all data for calculation

**Scoring to Storage:**
- Scoring_System calculates total score
- Storage_System persists score atomically
- Storage_System updates leaderboard in same transaction
- Storage_System updates quiz history in same transaction (Requirement 11)
- Storage_System returns updated rankings
- Quiz_Interface navigates to Quiz History scene (Requirement 11)
- Quiz_Interface displays latest result and full history

**Quiz History to Leaderboard (Requirement 11):**
- User views quiz history in QuizHistoryScene
- User clicks "View Leaderboard" for specific drawing
- Quiz_Interface navigates to LeaderboardScene with drawingId
- LeaderboardScene fetches top 5 scores with Reddit avatars
- User Profile Handler fetches avatars from Reddit API (with caching)
- LeaderboardScene displays usernames as u/username format

## Data Models

### Drawing Structure
```typescript
interface Drawing {
  id: string;                // Generated by Redis INCR
  createdBy: string;         // Reddit username
  createdAt: number;         // Unix timestamp
  answer: string;            // 1-50 chars, sanitized
  hint?: string;             // 0-100 chars, sanitized
  strokes: Stroke[];         // Compressed stroke data
  totalStrokes: number;      // For score calculation
}

interface Stroke {
  points: Point[];           // Drawing coordinates
  color: string;             // Hex color code
  width: number;             // Brush size in pixels
  timestamp: number;         // Relative to drawing start
}

interface Point {
  x: number;                 // 0-360, rounded to 1 decimal
  y: number;                 // 0-360, rounded to 1 decimal
}
```

### Score Structure
```typescript
interface Score {
  id: string;                // Generated by Redis INCR
  drawingId: string;         // Reference to drawing
  userId: string;            // Reddit username
  score: number;             // Total calculated score
  baseScore: number;         // (total - viewed) × 100
  timeBonus: number;         // max(0, (60 - elapsed) × 10)
  elapsedTime: number;       // Seconds
  viewedStrokes: number;     // Strokes seen before guess
  submittedAt: number;       // Unix timestamp
}
```

### User Profile Structure (Requirement 11)
```typescript
interface UserProfile {
  userId: string;            // Reddit username
  avatarUrl?: string;        // Reddit user avatar URL (optional)
  displayName: string;       // Formatted as u/username
}
```

### Global Leaderboard Structure
```typescript
interface GlobalLeaderboardEntry {
  userId: string;            // Reddit username
  totalScore: number;        // Sum of all best scores from answered quizzes
  quizCount: number;         // Number of unique quizzes answered
  lastUpdated: number;       // Unix timestamp of last score update
  rank: number;              // Global ranking position (1-based)
}
```

### Quiz History Structure (Requirement 11)
```typescript
interface QuizHistoryEntry {
  drawingId: string;         // Reference to drawing
  drawingAnswer: string;     // Answer text for reference
  score: number;             // User's score on this quiz
  rank: number;              // User's rank (1-5 if in top 5, null otherwise)
  submittedAt: number;       // Unix timestamp
  baseScore: number;         // Score breakdown for display
  timeBonus: number;         // Score breakdown for display
}
```

### Subreddit Post Structure (Requirement 14)
```typescript
interface SubredditPost {
  postId: string;            // Reddit post ID
  drawingId: string;         // Reference to drawing
  subredditName: string;     // Name of subreddit (e.g., "gaming")
  postUrl: string;           // Full Reddit post URL
  postTitle: string;         // Title of the Reddit post
  postedAt: number;          // Unix timestamp of post creation
  postedBy: string;          // Reddit username of creator
}
```

### Subreddit Ranking Structure (Requirement 15)
```typescript
interface SubredditRankingEntry {
  userId: string;            // Reddit username
  subredditName: string;     // Name of subreddit
  totalScore: number;        // Sum of best scores for quizzes in this subreddit
  quizCount: number;         // Number of unique quizzes answered in this subreddit
  rank: number;              // Ranking position within subreddit (1-based)
  lastUpdated: number;       // Unix timestamp of last score update
}
```

### Subreddit Quiz Metadata (Requirement 15)
```typescript
interface SubredditQuizMetadata {
  drawingId: string;         // Reference to drawing
  subredditName: string;     // Name of subreddit where posted
  postId: string;            // Reddit post ID
  answer: string;            // Drawing answer (for display purposes)
  createdBy: string;         // Creator username
  postedAt: number;          // Post creation timestamp
}
```


## Client Components

### Title Screen (Main Menu)
- Primary navigation hub for all game modes
- Main action buttons: "Create Drawing", "Play Quiz"
- Secondary navigation buttons: "Leaderboard", "My History"
- Leaderboard and My History buttons: smaller size, horizontally aligned
- Responsive layout: buttons stack vertically on narrow screens

#### Layout Structure
```
┌─────────────────────────────────────────────┐
│                                             │
│           What Did I Draw?                  │
│                                             │
├─────────────────────────────────────────────┤
│                                             │
│         [Create Drawing]                    │
│                                             │
│         [Play Quiz]                         │
│                                             │
│    [Leaderboard]  [My History]              │
│     (small)         (small)                 │
│                                             │
└─────────────────────────────────────────────┘
```
- **Title**: Game title centered at top
- **Primary actions**: Large buttons for main game modes (Create Drawing, Play Quiz)
- **Secondary actions**: Smaller buttons horizontally aligned
  - "Leaderboard" button: Navigate to global leaderboard
  - "My History" button: Navigate to personal quiz history
- **Button sizing**: Secondary buttons ~60-70% size of primary buttons
- **Spacing**: Consistent padding between all elements

### Drawing Canvas
- 360x360px HTML5 canvas with Phaser.js
- Tools: pen, undo
- Colors: 8 options (black, red, green, blue, yellow, magenta, cyan, white)
- Brush sizes: 5 options (1px, 3px, 5px, 8px, 12px)
- "Finish" button to complete drawing and trigger answer/hint input workflow
- "Back" button smaller than primary UI, no overlap with other elements
- Showing stroke count
- Answer/hint input form displayed after clicking "Finish" button
- Return to title screen after submitting answer and hint
- Touch input support with event debouncing (50ms)
- Responsive layout preventing UI overlap and horizontal scrolling on all screen sizes

#### Layout Structure
```
┌─────────────────────────────────────────────┐
│ Back           Stroke count           Finish│
├─────────────────────────────────────────────┤
│                                             │
│                                             │
│                   Canvas                    │
│                                             │
│                                             │
│                                             |
├─────────────────────────────────────────────┤
|                                         Undo|
│ Pen colors: [Black][Red][Green][Blue]...    │
│ Stroke sizes: [1px][3px][5px][8px][12px]    │
└─────────────────────────────────────────────┘
```
- **Top bar**: Back button (left), Stroke count display (center), Finish button (right)
- **Center area**: 360×360px drawing canvas
- **Bottom-right of canvas**: Undo button
- **Bottom controls**: Pen color selector (8 colors: black, red, green, blue, yellow, magenta, cyan, white) and stroke size selector (5 sizes)

### Quiz Interface
- Playback viewer with play/pause controls
- Guess input field with real-time validation
- Score breakdown display (base + time bonus)
- Top 5 leaderboard per drawing with Reddit avatars (Requirement 11)
- Showing stroke count
- User's rank display if in top 5
- Reddit user profiles: avatar (32x32px or 40x40px) + u/username format (Requirement 11)

#### Layout Structure
```
┌─────────────────────────────────────────────┐
│ Back   Hint: [It has four legs] (optional)  │
├─────────────────────────────────────────────┤
│                                             │
│                                             │
│              Canvas (360x360)               │
│           (Playback Display)                │
│                                             │
│                                             │
├─────────────────────────────────────────────┤
│    Progress: 15/42 strokes  Time: 00:12     │
├─────────────────────────────────────────────┤
│           [Play/Pause Button]               │
├─────────────────────────────────────────────┤
│           Enter your answer:                │
│         [____Input____] [Submit]            │
└─────────────────────────────────────────────┘
```
- **Top bar**: Back button (top-left)
- **Center area**: 360×360px playback canvas (strokes drawn sequentially)
- **Progress bar**: Stroke progress (e.g., "15/42 strokes") and elapsed time (e.g., "Time: 00:12")
- **Playback control**: Play/Pause toggle button (centered)
- **Hint area**: Displayed when hint is available (optional)
- **Guess input area**:
  - Label "Enter your answer:" displayed above the input row
  - Input field and Submit button arranged horizontally below the label
  - Submit button positioned to the right of the input field

### Playback Engine
- Stroke-by-stroke replay preserving original timing
- Progress tracking communicated to Quiz_Interface
- Pause state maintained during guess submission
- Completion notification to Quiz_Interface

### Quiz History Interface (Requirement 11)
- Display user's personal quiz history (all answered quizzes)
- Show quiz result summary at top after answering
- List entries with: drawing answer, score, rank, date
- Sort by most recent first (descending submittedAt)
- Pagination: 10 entries per page
- Navigation buttons: "View Drawing Leaderboard", "Play Another Quiz", "Create Drawing"
- Empty state: "No quizzes answered yet" message
- Highlight just-completed quiz in list

#### Layout Structure
```
┌─────────────────────────────────────────────┐
│ Back        My Quiz History                 │
├─────────────────────────────────────────────┤
│                                             │
│ 1. "Cat"          850 pts  Rank 2  Jan 15  │
│    Base: 700  Bonus: 150                    │
│    [View Leaderboard]                       │
│                                             │
│ 2. "House"        650 pts  Rank 5  Jan 14  │
│    Base: 500  Bonus: 150                    │
│    [View Leaderboard]                       │
│                                             │
│ 3. "Tree"         400 pts  Rank -  Jan 13  │
│    Base: 400  Bonus: 0                      │
│    [View Leaderboard]                       │
│                                             │
└─────────────────────────────────────────────┘
```
- **Top bar**: Back button (left), "My Quiz History" title (center)
- **Latest result**: Summary of just-completed quiz (if navigated from quiz result)
- **History list**: Scrollable list of quiz entries (10 per page)
  - Each entry: drawing answer, score, rank, date
  - Score breakdown: base + time bonus
  - "View Leaderboard" button for each drawing
- **Bottom actions**: "Play Another Quiz", "Create Drawing" buttons

### Leaderboard Interface (Requirement 11)
- Display top 5 scores for a specific drawing
- Show Reddit user profiles with avatars and u/username format
- Display score breakdown (base score + time bonus) for each entry
- Highlight current user's rank if in top 5
- Navigation button to view user's personal quiz history
- Empty state: "No scores yet" message

#### Layout Structure
```
┌─────────────────────────────────────────────┐
│ Back       Drawing Leaderboard              │
├─────────────────────────────────────────────┤
│ Drawing: "Cat"                              │
├─────────────────────────────────────────────┤
│                                             │
│ 1. [Avatar] u/alice        850 pts         │
│    Base: 700  Bonus: 150                    │
│                                             │
│ 2. [Avatar] u/bob          780 pts  (You)  │
│    Base: 650  Bonus: 130                    │
│                                             │
│ 3. [Avatar] u/charlie      650 pts         │
│    Base: 500  Bonus: 150                    │
│                                             │
│ 4. [Avatar] u/dave         600 pts         │
│    Base: 550  Bonus: 50                     │
│                                             │
│ 5. [Avatar] u/eve          580 pts         │
│    Base: 480  Bonus: 100                    │
│                                             │
└─────────────────────────────────────────────┘
```
- **Top bar**: Back button (left), "Drawing Leaderboard" title (center), "My History" button (right)
- **Drawing info**: Display drawing answer (e.g., "Cat")
- **Leaderboard list**: Top 5 scores with Reddit user profiles
  - Each entry: avatar (32x32px or 40x40px), u/username, total score
  - Score breakdown: base + time bonus
  - Highlight current user's entry with "(You)" indicator
- **My History button**: Positioned in top-right corner, same row as Back button
  - Navigates to user's personal quiz history (QuizHistoryScene)
  - Same size as Back button for visual consistency
- **Bottom actions**: "Play Another Quiz", "Create Drawing" buttons
- **Empty state**: "No scores yet. Be the first to answer!"

### Global Leaderboard Interface
- Display global player rankings based on total scores (sum of all best quiz scores)
- Show top players with Reddit user profiles (avatars and u/username format)
- Display player's total score, quiz count, and global rank
- Highlight current user's rank if in leaderboard
- Pagination: Show top 10, 20, 50, or 100 players (configurable)
- Navigation: Back to title screen
- Empty state: "No players yet. Be the first!"

#### Layout Structure
```
┌─────────────────────────────────────────────┐
│ Back       Global Leaderboard               │
├─────────────────────────────────────────────┤
│                                             │
│ 1. [Avatar] u/alice       2,450 pts        │
│    Quizzes answered: 12                     │
│                                             │
│ 2. [Avatar] u/bob         2,100 pts (You)  │
│    Quizzes answered: 8                      │
│                                             │
│ 3. [Avatar] u/charlie     1,850 pts        │
│    Quizzes answered: 10                     │
│                                             │
│ 4. [Avatar] u/dave        1,600 pts        │
│    Quizzes answered: 7                      │
│                                             │
│ 5. [Avatar] u/eve         1,420 pts        │
│    Quizzes answered: 9                      │
│                                             │
│ ...                                         │
│                                             │
└─────────────────────────────────────────────┘
```
- **Top bar**: Back button (left), "Global Leaderboard" title (center)
- **Leaderboard list**: Scrollable list of player rankings
  - Each entry: rank number, avatar (32x32px or 40x40px), u/username, total score
  - Additional info: number of quizzes answered
  - Highlight current user's entry with "(You)" indicator
- **Score calculation**: Sum of best scores from all unique quizzes answered by each player
- **Ranking**: Sorted by total score (descending), ties broken by quiz count (ascending, fewer quizzes = higher rank)
- **Pagination**: Default show top 50, with option to load more
- **Bottom actions**: "Play Quiz", "Create Drawing" buttons

## Server Components

### API Handlers
```
POST /api/drawings                           - Save new drawing
GET  /api/drawings/:id                       - Get drawing data
GET  /api/drawings/random                    - Get random drawing
POST /api/scores                             - Submit score
GET  /api/leaderboard/global                 - Get global leaderboard (top players by total score)
GET  /api/leaderboard/:id                    - Get top 5 for drawing
GET  /api/user/:userId/quiz-history          - Get user's quiz history (Requirement 11)
GET  /api/user/:userId/profile               - Get Reddit user profile (avatar, etc.) (Requirement 11)
POST /api/subreddit/post                     - Share drawing quiz to subreddit (Requirement 14)
GET  /api/subreddit/:name/ranking            - Get subreddit-specific player rankings (Requirement 15)
GET  /api/subreddit/:name/quizzes            - Get quizzes posted to subreddit (Requirement 15)
```

### Drawing Handler
- Validates minimum 1 stroke, maximum 1000 strokes
- Validates coordinates within 360x360 bounds
- Sanitizes answer (1-50 chars) and hint (0-100 chars)
- Applies profanity filter using bad-words library
- Removes HTML/script tags via regex
- Compresses stroke data (rounds coordinates, shortens properties)
- Generates unique ID via Redis INCR on `drawings:id:counter`
- Returns drawing ID for confirmation

### Scoring Handler
- Validates drawing ID exists
- Validates user authentication via Reddit context
- Validates viewed_strokes ≤ total_strokes
- Validates elapsed_time ≥ 0
- Calculates: `base_score = (total_strokes - viewed_strokes) × 100`
- Calculates: `time_bonus = max(0, (60 - elapsed_seconds) × 10)`
- Total: `base_score + time_bonus`
- Updates rankings atomically using Redis WATCH/MULTI/EXEC
- Retries up to 3 times on transaction failure
- Returns score breakdown and updated rankings

### Data Handler
- Manages all Redis operations
- Handles compression/decompression of stroke data
- Ensures atomic score updates with retry logic
- Validates data integrity on retrieval
- Provides error recovery mechanisms

### Quiz History Handler (Requirement 11)
- Fetches user's complete quiz history from Redis
- Validates user authentication via Reddit context
- Retrieves entries from `user:{userId}:quiz-history` sorted set
- Uses ZREVRANGE for most-recent-first ordering
- Implements pagination (default: 10 entries per page)
- Enriches data with drawing answers from `drawings:meta:{id}`
- Calculates rank from leaderboard position
- Returns QuizHistoryEntry array with full details
- Handles empty history case

### User Profile Handler (Requirement 11)
- Fetches Reddit user profile via Reddit API
- Retrieves user avatar URL from Reddit
- Formats username as u/username
- Implements avatar caching (TTL: 1 hour) to reduce API calls
- Cache key: `cache:avatar:{userId}`
- Provides default avatar fallback if unavailable
- Returns UserProfile with avatar and display name

### Global Leaderboard Handler
- Fetches global player rankings from Redis sorted set
- Calculates total score for each player (sum of best scores from all unique quizzes)
- Retrieves player data including quiz count and last update timestamp
- Supports pagination (default: top 50 players, configurable to 10/20/50/100)
- Uses ZREVRANGE for ranking retrieval (sorted by total score, descending)
- Enriches data with Reddit user profiles (avatars) via User Profile Handler
- Calculates rank position (1-based) for each player
- Highlights current user's position if in leaderboard
- Returns GlobalLeaderboardEntry array with full details
- Handles empty leaderboard case
- Implements caching (TTL: 5 minutes) to reduce Redis load
- Cache key: `cache:global-leaderboard:{limit}`
- Invalidates cache on any score update

### Subreddit Post Handler (Requirement 14)
- Validates drawing ID exists in Redis
- Validates user authentication via Reddit context
- Validates subreddit name format and existence
- Creates Reddit post via Devvit's Reddit API
- Post content includes:
  - Custom title (or default: "Can you guess what I drew?")
  - Quiz link: `/quiz/{drawingId}`
  - Drawing metadata (creator, creation date)
  - Call-to-action to play the quiz
- Stores post mapping in Redis:
  - `drawing:{drawingId}:post` hash with postId, subredditName, postUrl, postedAt, postTitle, postedBy
  - `subreddit:{subredditName}:quizzes` sorted set (score: timestamp, member: drawingId)
- Returns post details including Reddit post URL
- Handles Reddit API errors:
  - Rate limiting: return 429 with retry-after header
  - Permission denied: return 403 with explanation
  - Invalid subreddit: return 400 with error message
  - Network errors: return 500 with retry option

### Subreddit Ranking Handler (Requirement 15)
- Fetches subreddit-specific player rankings from Redis
- Validates subreddit name parameter
- Retrieves from `subreddit:{name}:leaderboard` sorted set
- Uses ZREVRANGE for top players (sorted by total subreddit score, descending)
- Supports pagination (default: top 50, configurable to 10/20/50/100)
- For each player:
  - Fetches stats from `subreddit:{name}:player:{userId}` hash
  - Retrieves Reddit avatar via User Profile Handler (with caching)
  - Calculates rank position (1-based)
- Highlights current user's position if in ranking
- Implements caching (TTL: 5 minutes)
- Cache key: `cache:subreddit:{name}:ranking:{limit}`
- Invalidates cache on score update for that subreddit
- Returns SubredditRankingEntry array
- Handles empty ranking case

### Subreddit Quiz Browser Handler (Requirement 15)
- Fetches quizzes posted to specific subreddit
- Validates subreddit name parameter
- Retrieves from `subreddit:{name}:quizzes` sorted set using ZREVRANGE (newest first by timestamp)
- Implements pagination (20 quizzes per page)
- For each quiz:
  - Fetches drawing metadata from `drawings:meta:{id}`
  - Fetches post info from `drawing:{id}:post`
- Returns SubredditQuizMetadata array
- Handles empty quiz list case

## Storage Schema

```
# ID Generation
drawings:id:counter         -> String (INCR for unique IDs)
scores:id:counter           -> String (INCR for unique IDs)

# Drawing Storage
drawings:{id}               -> Hash (compressed stroke data)
                               Fields: strokes (JSON), totalStrokes
drawings:meta:{id}          -> Hash (answer, hint, metadata)
                               Fields: answer, hint, createdBy, createdAt
drawings:list               -> List (all drawing IDs, LPUSH for newest first)

# Score Storage
scores:{drawingId}:{userId} -> Hash (score data, stores only best score)
                               Fields: score, baseScore, timeBonus, 
                                       elapsedTime, viewedStrokes, submittedAt

# Rankings (Requirement 4)
leaderboard:{drawingId}     -> Sorted Set (top scores per drawing)
                               Score: user's total score (for ranking)
                               Member: userId
                               Maintains top 5 automatically via ZADD

# Quiz History (Requirement 11)
user:{userId}:quiz-history  -> Sorted Set (user's answered quizzes)
                               Score: submittedAt timestamp (for chronological sorting)
                               Member: JSON string with {drawingId, score, baseScore,
                                       timeBonus, rank, submittedAt}
                               Use ZREVRANGE for most-recent-first retrieval

# User Profiles (Requirement 11)
cache:avatar:{userId}       -> String (cached Reddit avatar URL)
                               TTL: 1 hour
                               Reduces Reddit API calls

# Global Leaderboard
global:leaderboard          -> Sorted Set (global player rankings)
                               Score: user's total score (sum of all best quiz scores)
                               Member: userId
                               Updated atomically when user score changes
player:{userId}:stats       -> Hash (player statistics)
                               Fields: totalScore, quizCount, lastUpdated
cache:global-leaderboard:{limit} -> String (cached global leaderboard JSON)
                               TTL: 5 minutes
                               Reduces Redis queries for leaderboard display

# Subreddit Integration (Requirement 14, 15)
drawing:{drawingId}:post    -> Hash (Reddit post information)
                               Fields: postId, subredditName, postUrl, postedAt,
                                       postTitle, postedBy
subreddit:{name}:quizzes    -> Sorted Set (quizzes posted to subreddit)
                               Score: postedAt timestamp
                               Member: drawingId
                               For chronological quiz browsing
subreddit:{name}:leaderboard -> Sorted Set (subreddit player rankings)
                               Score: user's total score within subreddit
                               Member: userId
                               Updated atomically with score submissions
subreddit:{name}:player:{userId} -> Hash (player stats within subreddit)
                               Fields: totalScore, quizCount, lastUpdated
cache:subreddit:{name}:ranking:{limit} -> String (cached subreddit ranking JSON)
                               TTL: 5 minutes
                               Reduces Redis queries
```

## Input Validation

### Drawing Validation
- Minimum: 1 stroke (required)
- Maximum: 1000 strokes (prevent abuse)
- Coordinates: x ∈ [0, 360], y ∈ [0, 360]
- Valid timestamps: monotonically increasing
- Color: must be in predefined palette
- Width: must be one of [1, 3, 5, 8, 12]

### Text Validation (Requirement 7)
- Answer: 1-50 characters, required
- Hint: 0-100 characters, optional
- Character set: UTF-8 (supports international characters including Japanese, emoji, etc.)
- HTML/script tag removal: `/<[^>]*>/g` regex before storage
- XSS prevention: HTML tags removed rather than escaped for stronger protection
- Profanity filter: bad-words library with default English dictionary
- Trim whitespace before validation

### Score Validation
- Drawing ID: must exist in Redis
- User: must be authenticated via Reddit context
- Viewed strokes: integer, 0 ≤ viewed ≤ total
- Elapsed time: number, ≥ 0 seconds
- Answer match: case-insensitive comparison after trim

## Data Flow

### Create Drawing Flow
1. User draws on canvas (Drawing_System)
2. User clicks "Finish" button
3. Client validates: minimum 1 stroke
4. Client displays answer/hint input form (modal or screen transition)
5. User enters answer (1-50 chars, required) and optional hint (0-100 chars)
6. User submits answer/hint form
7. Send to server: strokes, answer, hint, metadata
8. Server validates: stroke count, bounds, text format
9. Server sanitizes: remove HTML/scripts, apply profanity filter
10. Server compresses stroke data (30-40% reduction)
11. Server generates ID: Redis INCR on `drawings:id:counter`
12. Server stores: `drawings:{id}`, `drawings:meta:{id}`, update `drawings:list`
13. Server returns: drawing ID and success status
14. Client displays: success message with "Share to Subreddit" button (Requirement 14)
15. IF user clicks "Share to Subreddit":
    a. Client displays subreddit selection modal
    b. User selects subreddit and optionally enters custom post title
    c. Client sends POST /api/subreddit/post with drawingId, subredditName, postTitle
    d. Server creates Reddit post via Reddit API
    e. Server stores post mapping in Redis (`drawing:{id}:post`, `subreddit:{name}:quizzes`)
    f. Server returns post URL
    g. Client displays success with link to Reddit post
16. Client navigates: return to title screen

### Quiz Flow
1. User selects "Play Quiz" (Quiz_Interface)
2. Client requests: random drawing from server
3. Server queries: RANDOMKEY from `drawings:list` or LINDEX with random index
4. Server retrieves: `drawings:{id}` and `drawings:meta:{id}`
5. Server decompresses: stroke data
6. Server sends: complete drawing data to client
7. Client initializes: Playback_System with drawing data
8. Playback_System notifies: Quiz_Interface ready for interaction
9. User clicks: play button
10. Playback_System: replays strokes with timing, tracks progress
11. User submits: guess during playback
12. Playback_System: pauses, sends viewed stroke count
13. Client sends: guess text, elapsed time, viewed strokes
14. Server validates: answer match (case-insensitive, trimmed)
15. Server calculates: base score and time bonus
16. Server updates: score, leaderboard, and quiz history atomically (see below)
17. Server adds entry to `user:{userId}:quiz-history` sorted set
18. Server returns: score breakdown, rankings, user's rank
19. Client navigates: to Quiz History scene (Requirement 11)
20. Client displays: latest result at top, full quiz history below
21. Client offers: "View Drawing Leaderboard", "Play Another", "Create Drawing"

### Atomic Score Update (Requirement 9, 11, 15)
```
# Retry loop: up to 3 attempts
For attempt in 1..3:
  WATCH scores:{drawingId}:{userId}
  WATCH leaderboard:{drawingId}
  WATCH user:{userId}:quiz-history
  WATCH player:{userId}:stats
  WATCH global:leaderboard

  # If drawing is associated with subreddit, also watch subreddit leaderboard
  subredditName = HGET drawing:{drawingId}:post "subredditName"
  IF subredditName exists:
    WATCH subreddit:{subredditName}:leaderboard
    WATCH subreddit:{subredditName}:player:{userId}

  # Get existing score
  existingScore = HGET scores:{drawingId}:{userId} "score"

  # Only update if new score is better
  IF newScore > existingScore OR existingScore is NULL:
    # Calculate rank from leaderboard position
    rank = ZREVRANK leaderboard:{drawingId} userId + 1 (or null if not in top 5)

    # Get current player stats for global leaderboard update
    currentTotalScore = HGET player:{userId}:stats "totalScore" (default: 0)
    currentQuizCount = HGET player:{userId}:stats "quizCount" (default: 0)

    # Calculate new total score (subtract old score, add new score)
    scoreDifference = newScore - (existingScore OR 0)
    newTotalScore = currentTotalScore + scoreDifference
    newQuizCount = currentQuizCount + (existingScore is NULL ? 1 : 0)

    # If subreddit quiz, get subreddit player stats
    IF subredditName exists:
      currentSubredditTotalScore = HGET subreddit:{subredditName}:player:{userId} "totalScore" (default: 0)
      currentSubredditQuizCount = HGET subreddit:{subredditName}:player:{userId} "quizCount" (default: 0)
      newSubredditTotalScore = currentSubredditTotalScore + scoreDifference
      newSubredditQuizCount = currentSubredditQuizCount + (existingScore is NULL ? 1 : 0)

    MULTI
      # Update user's score for this drawing
      HMSET scores:{drawingId}:{userId}
        score: newScore
        baseScore: baseScore
        timeBonus: timeBonus
        elapsedTime: elapsedTime
        viewedStrokes: viewedStrokes
        submittedAt: timestamp

      # Update per-drawing leaderboard (keeps top scores automatically)
      ZADD leaderboard:{drawingId} newScore userId

      # Trim to top 5 only
      ZREMRANGEBYRANK leaderboard:{drawingId} 0 -6

      # Update quiz history (Requirement 11)
      # Store as JSON: {drawingId, score, baseScore, timeBonus, rank, submittedAt}
      ZADD user:{userId}:quiz-history timestamp JSON_STRING

      # Update global leaderboard
      ZADD global:leaderboard newTotalScore userId

      # Update player stats
      HMSET player:{userId}:stats
        totalScore: newTotalScore
        quizCount: newQuizCount
        lastUpdated: timestamp

      # Update subreddit leaderboard if applicable (Requirement 15)
      IF subredditName exists:
        ZADD subreddit:{subredditName}:leaderboard newSubredditTotalScore userId
        HMSET subreddit:{subredditName}:player:{userId}
          totalScore: newSubredditTotalScore
          quizCount: newSubredditQuizCount
          lastUpdated: timestamp

        # Invalidate subreddit ranking cache
        DEL cache:subreddit:{subredditName}:ranking:*

      # Invalidate global leaderboard cache
      DEL cache:global-leaderboard:*
    EXEC

    IF EXEC succeeded:
      Break retry loop
    ELSE:
      IF attempt < 3:
        Wait 10ms * attempt (exponential backoff)
        Continue retry loop
      ELSE:
        Return error to client
```

## State Management (Requirement 10)

### Phaser Scene Management
- **Purpose**: Handle active game state and rendering
- **Scenes**:
  - `TitleScene`: Main menu with navigation to all modes
  - `DrawingScene`: Active canvas, tools, stroke recording
  - `QuizScene`: Playback engine, guess input, timer, subreddit context display
  - `QuizHistoryScene`: User's quiz history display (Requirement 11)
  - `LeaderboardScene`: Rankings display per drawing (top 5 with Reddit avatars)
  - `GlobalRankingScene`: Global player rankings by total score
  - `SubredditRankingScene`: Subreddit-specific player rankings (Requirement 15)
  - `SubredditQuizBrowseScene`: Browse and select quizzes from subreddit (Requirement 15)
  - `SubredditShareModal`: Modal for sharing drawing to subreddit (Requirement 14)
- **Transitions**: Managed by Phaser scene stack

### Scene Lifecycle Management
Proper lifecycle management is critical to prevent state persistence between scene activations.

- **init()**: Called every time a scene starts (before create())
  - **MUST** reset all instance properties to prevent state persistence
  - **MUST** clear graphics objects if they exist (e.g., `this.canvas.clear()`)
  - **MUST** reset DOM element references to null
  - Example properties to reset: drawing data, stroke indices, timer states, playback states

- **create()**: Called after init() to create new game objects
  - Initializes UI elements, canvas, event listeners
  - Fetches fresh data from API (e.g., new random drawing for Quiz)

- **destroy()**: Called when scene is removed from game
  - Clean up DOM elements and event listeners
  - Called automatically by Phaser when switching scenes

**Critical Issue Prevented**: Without `init()`, Phaser scene instances persist in memory between activations, causing previous state (drawings, progress, timers) to remain when returning to a scene.

**Example: Quiz scene state reset**
```typescript
init(): void {
  // Reset all state variables
  this.drawingData = null;
  this.completedStrokes = [];
  this.currentStrokeIndex = 0;
  this.currentPointIndex = 0;
  this.isPlaying = false;
  this.playbackStartTime = 0;
  this.pausedTime = 0;

  // Clear graphics if exists
  if (this.canvas) {
    this.canvas.clear();
  }

  // Reset DOM element references
  this.guessInput = null;
  this.inputContainer = null;
}
```

## Navigation

### Mode Structure
```
Home / Main Menu (Title Screen)
 ├─ Create Drawing
 │   ├─ Canvas (active drawing)
 │   ├─ Finish → Answer/Hint Input Form → Success Screen
 │   ├─ Success Screen:
 │   │   ├─ "Share to Subreddit" button (Requirement 14)
 │   │   │   └─ Subreddit Selection Modal → Reddit Post Creation → Return to Title Screen
 │   │   └─ "Skip" or "Done" → Return to Title Screen
 │   └─ Back button (top-left) → Title Screen
 ├─ Play Quiz
 │   ├─ Random Drawing Selection OR Subreddit Quiz Browse
 │   ├─ Playback & Guess
 │   ├─ Submit Answer → Quiz History (with subreddit context if applicable)
 │   └─ Back button (top-left) → Title Screen
 ├─ Global Ranking
 │   ├─ Display top players by total score (sum of all best quiz scores)
 │   ├─ Show player avatars, usernames, total scores, and quiz counts
 │   ├─ Pagination: top 50 by default (configurable)
 │   ├─ Highlight current user's rank if in leaderboard
 │   └─ Back button (top-left) → Title Screen
 ├─ My History
 │   ├─ Show Latest Result (if just completed quiz)
 │   │   └─ If from subreddit: "Your rank in r/{name}: #X" (Requirement 15)
 │   ├─ List All User's Answered Quizzes (most recent first)
 │   │   └─ Subreddit badge displayed if quiz from subreddit
 │   ├─ Navigation Options:
 │   │   ├─ View Drawing Leaderboard (for specific drawing)
 │   │   ├─ View Subreddit Ranking (if quiz from subreddit)
 │   │   ├─ Play Another Quiz
 │   │   └─ Create Drawing
 │   └─ Back button (top-left) → Title Screen
 ├─ Drawing Leaderboard (per drawing)
 │   ├─ Top 5 Scores with Reddit Avatars (Requirement 11)
 │   ├─ User's Rank (if applicable)
 │   ├─ Username formatted as u/username (Requirement 11)
 │   ├─ My History button (top-right) → My History (Requirement 11)
 │   └─ Back button (top-left) → My History or Title Screen
 ├─ Subreddit Ranking (Requirement 15)
 │   ├─ Subreddit Selection (list of participated subreddits)
 │   ├─ Display top players in selected subreddit
 │   ├─ Show avatars, usernames, total subreddit scores, quiz counts
 │   ├─ Pagination: top 50 by default (configurable)
 │   ├─ Highlight current user's rank if in ranking
 │   └─ Back button (top-left) → Title Screen
 └─ Subreddit Quiz Browse (Requirement 15)
     ├─ Subreddit Selection
     ├─ Display quizzes posted to selected subreddit (newest first)
     ├─ Pagination: 20 quizzes per page
     ├─ Select quiz → Play Quiz with subreddit context
     └─ Back button (top-left) → Title Screen
```

### Unified Navigation
- "Back" button available in all modes, positioned in top-left corner
- Back button sized smaller than primary UI elements to avoid visual clutter
- Back button positioned with padding (10-15px from edges) to prevent overlap
- Main menu (title screen) accessible from all scenes via back button

## Error Handling

### Loading Indicators
- **Loading dialog** displayed during all async operations:
  - Play Quiz: "Loading quiz..." shown while fetching drawing from server
  - Submit Guess: "Submitting guess..." shown while sending guess to server
  - Create Drawing: "Saving drawing..." shown while saving drawing to server
  - Visual: Spinner animation with message text
  - z-index: 9999 to appear above all other UI elements
  - Backdrop: Semi-transparent black (rgba(0, 0, 0, 0.7))

### Client Errors
- **Canvas initialization failure**: 
  - Display: "Unable to load drawing canvas. Please refresh the page."
  - Log: Error details to console
  - Action: Provide refresh button

- **Network timeout** (30 seconds):
  - Display: "Connection timeout. Retrying..."
  - Action: Retry with exponential backoff (1s, 2s, 4s)
  - Max retries: 3
  - Final failure: "Unable to connect. Please check your connection."

- **Invalid input**:
  - Display: Inline validation feedback below input field
  - Examples: "Answer must be 1-50 characters", "Drawing must have at least 1 stroke"
  - Prevent submission until valid

### Server Errors
- **Missing drawing (404)**:
  - Response: `{error: "NOT_FOUND", message: "Drawing not found", code: 404}`
  - Client display: "This drawing no longer exists. Try another one."
  - Action: Offer "Play Another Quiz" button

- **Invalid input (360)**:
  - Response: `{error: "INVALID_INPUT", message: "Answer must be 1-50 characters", code: 360}`
  - Client display: Show specific validation message
  - Action: Allow user to correct and resubmit

- **Redis connection failure (500)**:
  - Response: `{error: "SERVER_ERROR", message: "Unable to process request. Please try again.", code: 500}`
  - Server action: Log error with full context for admin review
  - Client display: Generic error with retry option
  - Retry: Same as network timeout

- **Atomic transaction failure** (Requirement 9):
  - Server action: Retry up to 3 times with exponential backoff
  - After 3 failures: Return 500 error
  - Client: Display retry option to user

### Error Format
```typescript
interface ErrorResponse {
  error: "NOT_FOUND" | "INVALID_INPUT" | "SERVER_ERROR" | "UNAUTHORIZED";
  message: string;  // User-friendly description
  code: 360 | 404 | 500 | 401;
  details?: any;    // Optional technical details for debugging
}
```

## Performance Optimization

### Compression (Requirement 6)
- **Coordinate rounding**: 3 decimals → 1 decimal (e.g., 123.456 → 123.5)
- **Property shortening**: 
  - `points` → `p`
  - `color` → `c`
  - `width` → `w`
  - `timestamp` → `t`
  - `x` → `x` (keep short)
  - `y` → `y` (keep short)
- **Result**: 30-40% size reduction
- **Quality**: No visible impact on drawing replay

### Caching
- **Leaderboard cache**: Top 5 per drawing
  - Key: `cache:leaderboard:{drawingId}`
  - TTL: 5 minutes
  - Invalidate: On new score submission for that drawing
  
- **Frequently accessed drawings**: 
  - Key: `cache:drawing:{drawingId}`
  - TTL: 10 minutes
  - Criteria: Accessed 10+ times in last hour
  
- **Cache strategy**: 
  - Check cache first
  - On miss: fetch from primary storage, populate cache
  - On TTL expiry: lazy refresh on next request

### Mobile Optimization (Requirement 5)
- **Touch events**: Debounce at 50ms to prevent excessive events
- **Canvas rendering**: Use requestAnimationFrame for smooth drawing
- **Responsive breakpoint**: 768px
  - Below: Single column layout, larger touch targets (44px minimum)
  - Above: Two column layout where appropriate
- **Touch targets**: Minimum 44×44px for all interactive elements
- **Viewport**: `<meta name="viewport" content="width=device-width, initial-scale=1">`
- **UI Overlap Prevention**:
  - All UI elements positioned to prevent overlap on all screen sizes
  - Back button (top-left) with sufficient padding (10-15px) to avoid overlap with other elements
  - Drawing tools, canvas, and buttons arranged using flexible layouts (flexbox/grid)
  - Vertical stacking of elements on narrow screens when needed
- **Horizontal Scrolling Prevention**:
  - No horizontal scrolling on any screen size (320px to 1920px+)
  - Test on common mobile widths: 320px, 375px, 414px, 768px
  - Test on desktop widths: 1024px, 1440px, 1920px
  - Use max-width constraints and flexible sizing to fit all screen widths

## Security

### Input Sanitization (Requirement 7)
- **HTML/Script removal**: Strip all tags using `/<[^>]*>/g` before storage
- **XSS prevention**: Tags are removed rather than escaped, providing stronger protection
- **Profanity filter**: bad-words library with English dictionary
- **SQL injection**: N/A (Redis key-value store, no SQL)
- **Command injection**: Validate all Redis keys follow expected patterns

### Data Validation
- All numeric inputs: validate type and range
- All string inputs: validate length and character set
- All IDs: validate format before Redis queries
- All user content: sanitize before storage and display


## Testing Requirements

### Unit Tests
- Drawing validation logic: stroke count, bounds, format
- Score calculation algorithm: base score, time bonus, edge cases
- Data compression/decompression: round-trip integrity
- Text sanitization: HTML removal, profanity filter, XSS prevention
- Atomic transaction retry logic: success, failure, partial failure

### Integration Tests
- Drawing save → retrieve flow: full cycle with compression
- Score submission → ranking update: atomic operation verification
- Complete quiz gameplay cycle: drawing load → playback → guess → score
- Concurrent score submissions: verify atomic updates prevent race conditions

### Performance Tests
- Canvas with 500+ strokes: rendering performance, memory usage
- Concurrent score submissions: 10+ simultaneous users on same drawing
- Mobile touch responsiveness: input lag measurement, 60fps target
- Redis operations: query time under 50ms for 95th percentile
- Compression efficiency: verify 30-40% reduction across sample set

### Error Handling Tests
- Network failures: timeout, retry logic, error display
- Invalid inputs: validation messages, submission prevention
- Redis failures: transaction retries, error recovery
- Concurrent update conflicts: WATCH/MULTI/EXEC behavior

## Design Decisions

### Fixed Canvas Size (360×360px)
- **Rationale**: Consistent aspect ratio (1:1) across all devices
- **Benefit**: Fits mobile screens in both portrait and landscape orientation
- **Benefit**: Maintains drawing proportions for fair comparison
- **Tradeoff**: Not full-screen on larger devices (acceptable)

### Stroke-Based Storage
- **Rationale**: Enables timed replay of drawing process
- **Benefit**: Smaller size than bitmap images
- **Benefit**: Smooth animation during playback
- **Tradeoff**: More complex than image storage (worth it for core gameplay)

### Top 5 Leaderboard Only (per drawing)
- **Rationale**: Sufficient for competitive motivation
- **Benefit**: Reduces storage complexity (Requirement 4)
- **Benefit**: Faster Redis queries (ZRANGE 0 4)
- **Tradeoff**: Users below rank 5 don't see their rank (acceptable for simplicity)

### Single Compression Strategy
- **Rationale**: 30-40% reduction without quality loss (Requirement 6)
- **Benefit**: Simple implementation and maintenance
- **Benefit**: Predictable performance characteristics
- **Tradeoff**: Not optimal for all drawing types (acceptable tradeoff)

### Atomic Score Updates with WATCH/MULTI/EXEC
- **Rationale**: Prevents race conditions in concurrent submissions (Requirement 9)
- **Benefit**: Ensures data consistency between scores and rankings
- **Benefit**: Handles multiple simultaneous guesses safely
- **Implementation**: Retry up to 3 times with exponential backoff
- **Tradeoff**: Slightly higher latency under contention (rare occurrence)

### Global Leaderboard with Per-Drawing Rankings
- **Rationale**: Dual ranking system provides both individual drawing competition and overall player comparison
- **Global leaderboard**: Sum of best scores from all unique quizzes answered by each player
  - **Benefit**: Motivates players to answer more quizzes and improve overall performance
  - **Benefit**: Provides long-term progression and competition context
  - **Implementation**: Redis sorted set updated atomically with each score submission
  - **Caching**: 5-minute TTL to reduce Redis load
- **Per-drawing rankings**: Top 5 scores for each specific drawing
  - **Benefit**: Clear competition context for each drawing
  - **Benefit**: Encourages replay to improve rank on specific drawings
  - **Implementation**: Separate sorted sets per drawing, trimmed to top 5
- **Tradeoff**: Slightly increased storage and complexity (acceptable for enhanced engagement)
- **No weekly rankings**: Not implemented to maintain simplicity (may be added in future)

### bad-words Library for Profanity Filtering
- **Rationale**: Mature, maintained library with reasonable default dictionary
- **Benefit**: Covers common profanity without manual list maintenance
- **Benefit**: Easy to extend with custom word lists if needed
- **Tradeoff**: Not perfect (no filter is), but good baseline

### Redis INCR for ID Generation
- **Rationale**: Atomic, sequential, guaranteed unique
- **Benefit**: Simple implementation
- **Benefit**: Predictable performance
- **Tradeoff**: Sequential IDs reveal creation order (acceptable for this use case)

This design provides complete functionality for all requirements while maintaining simplicity, performance, and data integrity.